version: 2
jobs:
  build:
    docker:
      - image: circleci/php:7.4-cli
    steps:
      - run: sudo apt update -y
      - run: sudo apt install -y libpng-dev libjpeg-dev
      - run: sudo docker-php-ext-install gd
      - run: composer create-project drupal-composer/drupal-project:9.x-dev drupal --no-interaction --ignore-platform-reqs
      - checkout:
          path: date_recur_source
      - run: cd drupal && composer config repositories.daterecur "{\"type\":\"path\", \"url\":\"../date_recur_source\", \"options\":{\"symlink\":false}}"
      - run: cd drupal && composer require drupal/date_recur
      - save_cache:
          key: my-key-{{ .Revision }}
          paths:
            - drupal/

  coding_standards:
    docker:
      - image: circleci/php:7.4-cli
    steps:
      - restore_cache:
          key: my-key-{{ .Revision }}
      - run: ./vendor/bin/phpcs --standard drupal/web/modules/contrib/date_recur/phpcs.xml drupal/web/modules/contrib/date_recur > ~/phpcs-report.txt
      - run: cat ~/phpcs-report.txt
      - store_artifacts:
          path: ~/phpcs-report.txt

  static_analysis:
    docker:
      - image: circleci/php:7.4-cli
    steps:
      - run: echo 'memory_limit=-1' | sudo tee -a /usr/local/etc/php/php.ini
      - run: php -i | grep memory_limit
      - restore_cache:
          key: my-key-{{ .Revision }}
      - run: ./vendor/bin/phpstan analyse --no-progress -c drupal/web/modules/contrib/date_recur/phpstan.neon --level=max > ~/phpstan-report.txt
      - store_artifacts:
          path: ~/phpstan-report.txt

workflows:
  version: 2
  test:
    jobs:
      - build
      - coding_standards:
          requires:
            - build
      - static_analysis:
          requires:
            - build
